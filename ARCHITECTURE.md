# План реализации системы проксирования через облачные хранилища

## Цель
Создать монорепозиторий с модулями:
- **listeners/** - LISTENER серверы (Deno) для разных провайдеров хранилища
- **callers/** - CALLER клиенты для разных платформ (Deno, Android/Kotlin)

**Важно**: Система должна поддерживать разные провайдеры облачных хранилищ (Яндекс Диск, Google Drive, Dropbox и др.) через абстракцию. Яндекс Диск - только одна из реализаций.

Начать с реализации LISTENER для Яндекс Диск.

## Архитектура системы

### Компоненты:
1. **LISTENER** (Deno) - сервер в интернете
   - Подключен к облачному хранилищу через абстрактный провайдер (StorageProvider)
   - Polling для мониторинга изменений в определенной папке
   - Обнаруживает запросы на подключение
   - Подключается к целевому серверу (GOAL)
   - Записывает ответы от GOAL в хранилище

2. **CALLER** - SOCKS5 сервер на устройстве пользователя
   - **callers/deno/** (Deno) - для тестирования
   - **callers/android/** (Kotlin) - для Android приложения
   - Принимает запросы от приложений через SOCKS5 (127.0.0.1:1080)
   - Использует ConnectionHandler для работы с хранилищем (абстракция)
   - Создает запросы через провайдер хранилища
   - Polling для проверки ответов от LISTENER

3. **StorageProvider** - абстракция для работы с облачными хранилищами
   - Интерфейс для чтения/записи файлов
   - Интерфейс для мониторинга изменений (polling)
   - Реализации: YandexDiskProvider, GoogleDriveProvider, DropboxProvider и т.д.

### Поток данных:
```
APP → CALLER (SOCKS5) → StorageProvider (создание запроса) → LISTENER (polling) → GOAL
GOAL → LISTENER → StorageProvider (запись ответа) → CALLER (polling) → APP
```

## Структура монорепозитория

```
mysogatone/
├── listeners/             # Модули LISTENER (Deno) - разные провайдеры
│   ├── yandex-disk/      # LISTENER для Яндекс Диск
│   │   ├── deno.json     # Конфигурация Deno проекта
│   │   ├── src/
│   │   │   ├── main.ts   # Точка входа
│   │   │   ├── storage-provider.ts # Реализация StorageProvider для Яндекс Диск
│   │   │   ├── monitor.ts # Polling мониторинг изменений
│   │   │   └── connection-handler.ts # Обработка подключений к GOAL
│   │   └── README.md
│   └── ...               # Другие провайдеры (google-drive/, dropbox/ и т.д.)
│
├── callers/               # Модули CALLER - разные платформы
│   ├── deno/             # CALLER на Deno - для тестирования
│   │   ├── deno.json     # Конфигурация Deno проекта
│   │   ├── src/
│   │   │   ├── main.ts   # Точка входа
│   │   │   ├── connection-handler.ts # Абстракция ConnectionHandler
│   │   │   ├── storage/ # Провайдеры хранилища
│   │   │   │   ├── storage-provider.ts # Интерфейс провайдера
│   │   │   │   ├── yandex-disk-provider.ts # Реализация для Яндекс Диск
│   │   │   │   └── ...   # Другие провайдеры
│   │   │   ├── yandex-disk-connection-handler.ts # ConnectionHandler через StorageProvider
│   │   │   ├── socks5-server.ts
│   │   │   └── socks5-handler.ts
│   │   └── README.md
│   │
│   └── android/          # CALLER для Android (Kotlin)
│       ├── build.gradle.kts
│       ├── src/main/kotlin/
│       │   ├── ConnectionHandler.kt # Абстракция (уже существует)
│       │   ├── DefaultConnectionHandler.kt # Базовая реализация (TCP)
│       │   ├── storage/ # Провайдеры хранилища
│       │   │   ├── StorageProvider.kt # Интерфейс провайдера
│       │   │   ├── YandexDiskProvider.kt # Реализация для Яндекс Диск
│       │   │   └── ...   # Другие провайдеры
│       │   ├── YandexDiskConnectionHandler.kt # ConnectionHandler через StorageProvider
│       │   ├── Socks5Server.kt
│       │   └── Socks5Handler.kt
│       └── README.md
│
├── shared/                # Общий код
│   └── protocol/          # Протокол обмена через хранилище (будет определен позже)
│
└── README.md              # Общий README для монорепы
```

## План реализации (поэтапно)

### Этап 1: LISTENER для Яндекс Диск (listeners/yandex-disk/)

#### 1.1 Базовая структура
- Создать папку `listeners/yandex-disk/`
- Настройка Deno проекта (deno.json)
- Структура модулей

#### 1.2 Интеграция с Яндекс Диском API
- Настройка OAuth аутентификации
- Реализация StorageProvider для Яндекс Диск
- Функции для работы с API (чтение/запись файлов)
- Загрузка и скачивание файлов через API
- Обработка ошибок API

#### 1.3 Polling и обработка запросов
- Реализация механизма периодического опроса API (polling)
- Обнаружение новых запросов на подключение
- Кэширование состояния для определения изменений
- Парсинг запросов (формат будет определен позже)
- Извлечение адреса и порта целевого сервера (GOAL)

#### 1.4 Установка соединений
- Подключение к целевому серверу (GOAL)
- Чтение данных от GOAL
- Запись ответов в Яндекс Диск через API

### Этап 2: CALLER для Deno (callers/deno/) - для тестирования

#### 2.1 Базовая структура
- Создать папку `callers/deno/`
- Переместить существующий код SOCKS5 сервера
- Настройка Deno проекта
- Адаптация ConnectionHandler для Deno/TypeScript

#### 2.2 Интеграция с Яндекс Диском API
- Реализация StorageProvider для Яндекс Диск (TypeScript)
- Реализация YandexDiskConnectionHandler
- OAuth аутентификация для API
- Создание запросов через API
- Polling для проверки ответов от LISTENER

### Этап 3: CALLER для Android (callers/android/) - будет реализован позже
- Создать папку `callers/android/`
- Переместить существующий код SOCKS5 сервера
- Реализация StorageProvider для Яндекс Диск (Kotlin)
- Реализация YandexDiskConnectionHandler
- Интеграция с Android SDK

## Основные компоненты

### LISTENER для Яндекс Диск (listeners/yandex-disk/)

#### main.ts
- Точка входа приложения
- Инициализация OAuth и подключения к Яндекс Диск API
- Инициализация мониторинга
- Основной цикл обработки запросов

#### storage-provider.ts
- Реализация StorageProvider интерфейса для Яндекс Диск
- OAuth аутентификация
- Функции для чтения/записи файлов через API
- Функции для загрузки/скачивания файлов
- Обработка ошибок API

#### monitor.ts
- Polling механизм для мониторинга изменений
- Периодический опрос API
- Обнаружение новых запросов
- Кэширование состояния
- Парсинг запросов

#### connection-handler.ts
- Обработка подключений к целевым серверам (GOAL)
- Установка TCP соединений
- Чтение данных от GOAL
- Запись ответов в Яндекс Диск через API

### CALLER для Deno (callers/deno/)

#### main.ts
- Точка входа приложения
- Инициализация SOCKS5 сервера
- Настройка ConnectionHandler с провайдером хранилища

#### storage-provider.ts
- Реализация StorageProvider интерфейса для Яндекс Диск (TypeScript)
- Аналогично реализации в LISTENER

#### yandex-disk-connection-handler.ts
- Реализация ConnectionHandler через StorageProvider
- Создание запросов в хранилище
- Polling для проверки ответов
- Передача данных между APP и хранилищем

#### socks5-server.ts и socks5-handler.ts
- SOCKS5 сервер и обработчик протокола
- Адаптация существующего кода для Deno

## Зависимости

### LISTENER (Deno):
- Deno runtime
- Стандартная библиотека Deno (HTTP клиент)
- OAuth библиотека для аутентификации (если нужна)

### CALLER Deno:
- Deno runtime
- Стандартная библиотека Deno (HTTP клиент, TCP)
- OAuth библиотека для аутентификации

### CALLER Android (Kotlin):
- Стандартная библиотека Kotlin
- HTTP клиент (OkHttp или Ktor) для работы с API
- OAuth библиотека для аутентификации
- Android SDK

## Важные замечания

### Polling вместо webhooks
- Яндекс Диск API не поддерживает подписку на события (webhooks)
- Необходимо использовать периодический опрос API (polling)
- Оптимизировать частоту опросов для баланса между отзывчивостью и нагрузкой
- Использовать кэширование состояния для определения реальных изменений

### Rate Limits и обработка ошибок
- Яндекс Диск API может иметь ограничения на количество запросов (rate limits)
- Необходимо реализовать обработку ошибки 429 (Too Many Requests)
- Использовать экспоненциальную задержку (exponential backoff) при получении 429
- Настроить разумную частоту polling (например, каждые 1-5 секунд)
- Реализовать retry механизм с задержками
- Мониторить количество запросов для предотвращения превышения лимитов
- Конкретные лимиты не указаны в документации, нужно тестировать эмпирически

### Абстракция провайдеров
- StorageProvider позволяет легко добавлять новые провайдеры хранилища
- Каждый провайдер реализует единый интерфейс
- ConnectionHandler работает с абстракцией, не завися от конкретного провайдера

### OAuth аутентификация
- Оба модуля требуют OAuth токен для доступа к API
- Необходимо настроить OAuth приложение в провайдере
- Токены нужно безопасно хранить и обновлять

## Тестирование

### LISTENER:
- Тестирование OAuth аутентификации
- Тестирование работы с Яндекс Диск API
- Тестирование polling механизма
- Тестирование обработки запросов
- Тестирование подключений к целевым серверам

### CALLER Deno:
- Тестирование SOCKS5 сервера
- Тестирование работы с хранилищем через API
- Тестирование polling механизма
- Интеграционное тестирование с LISTENER

### CALLER Android:
- Будет протестирован после реализации LISTENER и определения протокола

