#!/bin/sh
#
# Pre-commit hook –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∏ –ª–∏–Ω—Ç–µ—Ä–∞ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
#

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º...${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–∞–Ω–¥ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
if ! command -v deno >/dev/null 2>&1; then
    echo "${YELLOW}–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: Deno –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ PATH. –ü—Ä–æ–≤–µ—Ä–∫–∏ Deno –ø—Ä–æ–µ–∫—Ç–æ–≤ –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã.${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
ORIGINAL_DIR=$(pwd)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Deno –ø—Ä–æ–µ–∫—Ç–æ–≤
check_deno_project() {
    local project_dir=$1
    local project_name=$2
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ
    if echo "$CHANGED_FILES" | grep -q "^$project_dir"; then
        echo "${YELLOW}–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞: $project_name${NC}"
        cd "$ORIGINAL_DIR/$project_dir" || exit 1
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–≤–∫–ª—é—á–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–º–ø–æ—Ä—Ç–æ–≤)
        if command -v deno >/dev/null 2>&1; then
            echo "  ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤..."
            FORMAT_OUTPUT=$(deno task format:check 2>&1)
            FORMAT_EXIT=$?
            if [ $FORMAT_EXIT -ne 0 ]; then
                echo "${RED}  ‚úó –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏–ª–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ $project_name${NC}"
                echo "$FORMAT_OUTPUT"
                echo "${YELLOW}  üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ 'deno task format' –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è${NC}"
                cd "$ORIGINAL_DIR" || true
                exit 1
            fi
            echo "${GREEN}  ‚úì –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ${NC}"
            
            # –õ–∏–Ω—Ç–∏–Ω–≥
            echo "  ‚Üí –ó–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–∞..."
            LINT_OUTPUT=$(deno task lint 2>&1)
            LINT_EXIT=$?
            if [ $LINT_EXIT -ne 0 ]; then
                echo "${RED}  ‚úó –õ–∏–Ω—Ç–µ—Ä –æ–±–Ω–∞—Ä—É–∂–∏–ª –æ—à–∏–±–∫–∏ –≤ $project_name${NC}"
                echo "$LINT_OUTPUT"
                cd "$ORIGINAL_DIR" || true
                exit 1
            fi
            echo "${GREEN}  ‚úì –õ–∏–Ω—Ç–µ—Ä –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ${NC}"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
            echo "  ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤..."
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
            TYPE_CHECK_OUTPUT=$(deno check src/ 2>&1)
            TYPE_CHECK_EXIT=$?
            if [ $TYPE_CHECK_EXIT -ne 0 ]; then
                echo "${RED}  ‚úó –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ —Ç–∏–ø–æ–≤ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ $project_name${NC}"
                echo "$TYPE_CHECK_OUTPUT"
                cd "$ORIGINAL_DIR" || true
                exit 1
            fi
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Å—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
                TEST_TYPE_CHECK_OUTPUT=$(deno check tests/ 2>&1)
                TEST_TYPE_CHECK_EXIT=$?
                if [ $TEST_TYPE_CHECK_EXIT -ne 0 ]; then
                    echo "${RED}  ‚úó –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ —Ç–∏–ø–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö $project_name${NC}"
                    echo "$TEST_TYPE_CHECK_OUTPUT"
                    cd "$ORIGINAL_DIR" || true
                    exit 1
                fi
            fi
            echo "${GREEN}  ‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ${NC}"
            
            # –¢–µ—Å—Ç—ã
            if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
                echo "  ‚Üí –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º deno task test –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ–ª–∞–≥–æ–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
                # –í–∞–∂–Ω–æ: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ deno test –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ —Ñ–ª–∞–≥–æ–≤!
                # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—ã–≤–æ–¥ –∏ –∫–æ–¥ –≤—ã—Ö–æ–¥–∞
                set +e  # –û—Ç–∫–ª—é—á–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                TEST_OUTPUT=$(deno task test 2>&1)
                TEST_EXIT=$?
                set -e  # –í–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –≤—ã—Ö–æ–¥–∞ –∫–æ–º–∞–Ω–¥—ã
                if [ $TEST_EXIT -ne 0 ]; then
                    echo "${RED}  ‚úó –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏ –≤ $project_name (–∫–æ–¥ –≤—ã—Ö–æ–¥–∞: $TEST_EXIT)${NC}"
                    echo "$TEST_OUTPUT"
                    echo ""
                    echo "${RED}–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'deno task test' –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤, –∞ –Ω–µ 'deno test' –Ω–∞–ø—Ä—è–º—É—é!${NC}"
                    echo "${RED}–ö–æ–º–º–∏—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –≤ —Ç–µ—Å—Ç–∞—Ö.${NC}"
                    cd "$ORIGINAL_DIR" || true
                    exit 1
                fi
                echo "${GREEN}  ‚úì –¢–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ${NC}"
            else
                echo "${YELLOW}  ‚ö† –¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º${NC}"
            fi
        else
            echo "${YELLOW}  ‚ö† Deno –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏${NC}"
        fi
        
        cd "$ORIGINAL_DIR" || exit 1
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Kotlin –ø—Ä–æ–µ–∫—Ç–∞
check_kotlin_project() {
    local project_dir=$1
    local project_name=$2
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ
    if echo "$CHANGED_FILES" | grep -q "^$project_dir"; then
        echo "${YELLOW}–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞: $project_name${NC}"
        cd "$ORIGINAL_DIR/$project_dir" || exit 1
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
        if [ -f "build.gradle.kts" ] || [ -f "build.gradle" ]; then
            echo "  ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏..."
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Gradle
            if [ -f "gradlew" ]; then
                GRADLE_CMD="./gradlew"
            elif [ -f "gradlew.bat" ]; then
                GRADLE_CMD="gradlew.bat"
            else
                echo "${YELLOW}  ‚ö† Gradle wrapper –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É${NC}"
                cd "$ORIGINAL_DIR" || true
                return
            fi
            
            BUILD_OUTPUT=$($GRADLE_CMD build -x test 2>&1)
            BUILD_EXIT=$?
            if [ $BUILD_EXIT -ne 0 ]; then
                echo "${RED}  ‚úó –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –≤ $project_name${NC}"
                echo "$BUILD_OUTPUT"
                cd "$ORIGINAL_DIR" || true
                exit 1
            fi
            echo "${GREEN}  ‚úì –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ${NC}"
        fi
        
        cd "$ORIGINAL_DIR" || exit 1
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã
check_deno_project "listeners/yandex-disk" "LISTENER (Yandex Disk)"
check_deno_project "callers/deno" "CALLER (Deno)"
check_kotlin_project "callers/android" "CALLER (Android)"

echo "${GREEN}‚úì –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!${NC}"
exit 0

