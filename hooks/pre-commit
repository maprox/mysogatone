#!/bin/sh
#
# Pre-commit hook для запуска тестов и линтера перед коммитом
#

set -e

# Цвета для вывода
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}Запуск проверок перед коммитом...${NC}"

# Проверка наличия необходимых команд (не критично, просто предупреждение)
if ! command -v deno >/dev/null 2>&1; then
    echo "${YELLOW}Предупреждение: Deno не найден в PATH. Проверки Deno проектов будут пропущены.${NC}"
fi

# Проверка измененных файлов
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Сохраняем текущую директорию
ORIGINAL_DIR=$(pwd)

# Проверка Deno проектов
check_deno_project() {
    local project_dir=$1
    local project_name=$2
    
    # Проверяем, есть ли изменения в этом проекте
    if echo "$CHANGED_FILES" | grep -q "^$project_dir"; then
        echo "${YELLOW}Проверка проекта: $project_name${NC}"
        cd "$ORIGINAL_DIR/$project_dir" || exit 1
        
        # Линтинг
        if command -v deno >/dev/null 2>&1; then
            echo "  → Запуск линтера..."
            LINT_OUTPUT=$(deno task lint 2>&1)
            LINT_EXIT=$?
            if [ $LINT_EXIT -ne 0 ]; then
                echo "${RED}  ✗ Линтер обнаружил ошибки в $project_name${NC}"
                echo "$LINT_OUTPUT"
                cd "$ORIGINAL_DIR" || true
                exit 1
            fi
            echo "${GREEN}  ✓ Линтер прошел успешно${NC}"
            
            # Проверка типов
            echo "  → Проверка типов..."
            # Проверяем исходный код
            TYPE_CHECK_OUTPUT=$(deno check src/ 2>&1)
            TYPE_CHECK_EXIT=$?
            if [ $TYPE_CHECK_EXIT -ne 0 ]; then
                echo "${RED}  ✗ Обнаружены ошибки типов в исходном коде $project_name${NC}"
                echo "$TYPE_CHECK_OUTPUT"
                cd "$ORIGINAL_DIR" || true
                exit 1
            fi
            # Проверяем тесты, если они есть
            if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
                TEST_TYPE_CHECK_OUTPUT=$(deno check tests/ 2>&1)
                TEST_TYPE_CHECK_EXIT=$?
                if [ $TEST_TYPE_CHECK_EXIT -ne 0 ]; then
                    echo "${RED}  ✗ Обнаружены ошибки типов в тестах $project_name${NC}"
                    echo "$TEST_TYPE_CHECK_OUTPUT"
                    cd "$ORIGINAL_DIR" || true
                    exit 1
                fi
            fi
            echo "${GREEN}  ✓ Проверка типов прошла успешно${NC}"
            
            # Тесты
            if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
                echo "  → Запуск тестов..."
                # Используем deno task test для правильной передачи флагов разрешений
                # Важно: НЕ используйте deno test напрямую без флагов!
                # Запускаем тесты и захватываем вывод и код выхода
                set +e  # Отключаем немедленный выход при ошибке
                TEST_OUTPUT=$(deno task test 2>&1)
                TEST_EXIT=$?
                set -e  # Включаем обратно
                
                # Проверяем код выхода команды
                if [ $TEST_EXIT -ne 0 ]; then
                    echo "${RED}  ✗ Тесты не прошли в $project_name (код выхода: $TEST_EXIT)${NC}"
                    echo "$TEST_OUTPUT"
                    echo ""
                    echo "${RED}ВАЖНО: Используйте 'deno task test' для запуска тестов, а не 'deno test' напрямую!${NC}"
                    echo "${RED}Коммит заблокирован из-за ошибок в тестах.${NC}"
                    cd "$ORIGINAL_DIR" || true
                    exit 1
                fi
                echo "${GREEN}  ✓ Тесты прошли успешно${NC}"
            else
                echo "${YELLOW}  ⚠ Тесты не найдены, пропускаем${NC}"
            fi
        else
            echo "${YELLOW}  ⚠ Deno не найден, пропускаем проверки${NC}"
        fi
        
        cd "$ORIGINAL_DIR" || exit 1
    fi
}

# Проверка Kotlin проекта
check_kotlin_project() {
    local project_dir=$1
    local project_name=$2
    
    # Проверяем, есть ли изменения в этом проекте
    if echo "$CHANGED_FILES" | grep -q "^$project_dir"; then
        echo "${YELLOW}Проверка проекта: $project_name${NC}"
        cd "$ORIGINAL_DIR/$project_dir" || exit 1
        
        # Проверка компиляции
        if [ -f "build.gradle.kts" ] || [ -f "build.gradle" ]; then
            echo "  → Проверка компиляции..."
            # Определяем команду для запуска Gradle
            if [ -f "gradlew" ]; then
                GRADLE_CMD="./gradlew"
            elif [ -f "gradlew.bat" ]; then
                GRADLE_CMD="gradlew.bat"
            else
                echo "${YELLOW}  ⚠ Gradle wrapper не найден, пропускаем проверку${NC}"
                cd "$ORIGINAL_DIR" || true
                return
            fi
            
            BUILD_OUTPUT=$($GRADLE_CMD build -x test 2>&1)
            BUILD_EXIT=$?
            if [ $BUILD_EXIT -ne 0 ]; then
                echo "${RED}  ✗ Ошибка компиляции в $project_name${NC}"
                echo "$BUILD_OUTPUT"
                cd "$ORIGINAL_DIR" || true
                exit 1
            fi
            echo "${GREEN}  ✓ Компиляция прошла успешно${NC}"
        fi
        
        cd "$ORIGINAL_DIR" || exit 1
    fi
}

# Проверяем все проекты
check_deno_project "listeners/yandex-disk" "LISTENER (Yandex Disk)"
check_deno_project "callers/deno" "CALLER (Deno)"
check_kotlin_project "callers/android" "CALLER (Android)"

echo "${GREEN}✓ Все проверки прошли успешно!${NC}"
exit 0

