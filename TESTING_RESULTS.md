# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã Mysogatone

–î–∞—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: 23 –Ω–æ—è–±—Ä—è 2025  
–í–µ—Ä—Å–∏—è: 1.1.2 (chore/update-version-to-1.1.2)

## –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- **CALLER**: Deno –Ω–∞ Windows 10, –ø–æ—Ä—Ç 1080 (SOCKS5)
- **LISTENER**: Deno –Ω–∞ Windows 10, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫ API
- **–ö–ª–∏–µ–Ω—Ç**: curl 8.16.0 —Å SOCKS5 –ø—Ä–æ–∫—Å–∏

## ‚úÖ HTTP –∑–∞–ø—Ä–æ—Å—ã (–ø–æ—Ä—Ç 80) - –†–ê–ë–û–¢–ê–ï–¢

### –¢–µ—Å—Ç: `curl.exe --proxy socks5://127.0.0.1:1080 http://httpbin.org/ip`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–®–ù–û**

```json
{
  "origin": "85.236.191.94"
}
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~9 —Å–µ–∫—É–Ω–¥ (–≤–∫–ª—é—á–∞—è –∑–∞–¥–µ—Ä–∂–∫–∏ polling —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫)

### –î–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã:

1. ‚úÖ **SOCKS5 Handshake**: –£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (No Auth)
2. ‚úÖ **CONNECT –∑–∞–ø—Ä–æ—Å**: –ö `52.44.182.178:80` (httpbin.org)
3. ‚úÖ **–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö**:
   - –ö–ª–∏–µ–Ω—Ç ‚Üí CALLER ‚Üí Yandex Disk ‚Üí LISTENER ‚Üí Server: 77 –±–∞–π—Ç (HTTP GET)
   - Server ‚Üí LISTENER ‚Üí Yandex Disk ‚Üí CALLER ‚Üí –ö–ª–∏–µ–Ω—Ç: 261 –±–∞–π—Ç (HTTP 200 OK)
4. ‚úÖ **HTTP –æ—Ç–≤–µ—Ç**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON —Å IP –∞–¥—Ä–µ—Å–æ–º

### –õ–æ–≥–∏ CALLER:

```
[Socks5Handler] Handshake —É—Å–ø–µ—à–µ–Ω
[Socks5Handler] CONNECT –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ
[YandexDiskConnectionHandler] –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è 52.44.182.178:80
[createStreams] –§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω, –Ω–∞—á–∏–Ω–∞–µ–º polling
[pollForResponse] ‚úÖ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª –æ—Ç–≤–µ—Ç–∞: 261 –±–∞–π—Ç
[Socks5Handler] –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞
```

### –õ–æ–≥–∏ LISTENER:

```
[bd10ca0b] ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å 52.44.182.178:80
[bd10ca0b] üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ 77 –±–∞–π—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–∞ GOAL...
[bd10ca0b] ‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
[bd10ca0b] üì• –ß—Ç–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç GOAL...
[readResponse] –í—Å–µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ: 261 –±–∞–π—Ç –∏–∑ 2 —á–∞–Ω–∫–æ–≤
[bd10ca0b] ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ 261 –±–∞–π—Ç –æ—Ç–≤–µ—Ç–∞
[bd10ca0b] üìÑ HTTP/1.1 200 OK ... Content-Length: 32
```

## ‚ö†Ô∏è HTTPS –∑–∞–ø—Ä–æ—Å—ã (–ø–æ—Ä—Ç 443) - –¢–†–ï–ë–£–ï–¢ –î–û–†–ê–ë–û–¢–ö–ò

### –¢–µ—Å—Ç: `curl.exe --proxy socks5://127.0.0.1:1080 https://ya.ru`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚ùå **–ß–ê–°–¢–ò–ß–ù–û –†–ê–ë–û–¢–ê–ï–¢**

```
curl: (55) Send failure: Connection was aborted
```

**–ü—Ä–æ–≥—Ä–µ—Å—Å**:
- ‚úÖ TLS handshake –Ω–∞—á–∞–ª—Å—è (`ALPN: server accepted http/1.1`)
- ‚úÖ –ü–µ—Ä–≤—ã–π —Ä–∞—É–Ω–¥ TLS handshake –ø—Ä–æ—à–µ–ª (ClientHello ‚Üí ServerHello)
- ‚ùå –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞—É–Ω–¥—ã TLS handshake –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- ‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–±–æ—Ä–≤–∞–ª–æ—Å—å

### –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. **TLS Handshake —Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–∞—É–Ω–¥–æ–≤**:
   - –†–∞—É–Ω–¥ 1: ClientHello (452 –±–∞–π—Ç) ‚Üí ServerHello + Certificate (4016 –±–∞–π—Ç) ‚úÖ
   - –†–∞—É–Ω–¥ 2: ClientKeyExchange ‚Üí ... ‚ùå (–Ω–æ–≤–æ–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ)
   - –†–∞—É–Ω–¥ 3: ChangeCipherSpec ‚Üí ... ‚ùå
   - –†–∞—É–Ω–¥ 4: Finished ‚Üí ... ‚ùå

2. **–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: "–û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å = –æ–¥–Ω–æ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"
   - LISTENER –∑–∞–∫—Ä—ã–≤–∞–µ—Ç TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
   - –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π requestId —Å–æ–∑–¥–∞–µ—Ç **–Ω–æ–≤–æ–µ** TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
   - TLS state —Ç–µ—Ä—è–µ—Ç—Å—è –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏

### –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—É:

```
CALLER:
[createStreams] –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è request-1: 452 –±–∞–π—Ç (TLS ClientHello)
[pollForResponse] ‚úÖ –ù–∞–π–¥–µ–Ω –æ—Ç–≤–µ—Ç: 4016 –±–∞–π—Ç (TLS ServerHello)

LISTENER:
[request-1] üîó –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ 77.88.44.242:443 (TCP)...
[request-1] ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
[request-1] üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ 452 –±–∞–π—Ç (ClientHello)
[request-1] ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ 4016 –±–∞–π—Ç (ServerHello + Certificate)
[request-1] üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ  ‚Üê –ü–†–û–ë–õ–ï–ú–ê!

CALLER (–Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å):
[createStreams] –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è request-2: 1910 –±–∞–π—Ç (ClientKeyExchange)

LISTENER:
[request-2] üîó –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ 34.107.243.93:443 (TCP)...  ‚Üê –ù–û–í–û–ï —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ!
[request-2] ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
[request-2] üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ 1910 –±–∞–π—Ç
[request-2] ‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç ClientKeyExchange –±–µ–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ TLS state
```

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –î–≤–æ–π–Ω–æ–π TLS handshake (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ)

**–ü—Ä–æ–±–ª–µ–º–∞**: LISTENER –ø—ã—Ç–∞–ª—Å—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–≤–æ—ë TLS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ—Ä—Ç–∞ 443:
```typescript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const useTls = port === 443;
if (useTls) {
  connectPromise = Deno.connectTls({ hostname, port });
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –î–≤–æ–π–Ω–æ–π TLS - –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ClientHello —á–µ—Ä–µ–∑ TLS —Ç—É–Ω–Ω–µ–ª—å LISTENER:
```
–ö–ª–∏–µ–Ω—Ç ‚Üí TLS ClientHello ‚Üí LISTENER ‚Üí [TLS —Ç—É–Ω–Ω–µ–ª—å] ‚Üí Server
Server –ø–æ–ª—É—á–∞–µ—Ç: [TLS encrypted [TLS ClientHello]] ‚Üê –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!
Server –æ—Ç–≤–µ—á–∞–µ—Ç: HTTP 400 Bad Request
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: LISTENER –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—ã—á–Ω–æ–µ TCP:
```typescript
// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const connectPromise = Deno.connect({ hostname, port });
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü—Ä–æ–∫—Å–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—ë—Ç –±–∞–π—Ç—ã:
```
–ö–ª–∏–µ–Ω—Ç ‚Üí TLS ClientHello ‚Üí LISTENER ‚Üí [TCP] ‚Üí Server
Server –ø–æ–ª—É—á–∞–µ—Ç: [TLS ClientHello] ‚Üê –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
Server –æ—Ç–≤–µ—á–∞–µ—Ç: TLS ServerHello + Certificate
```

### 2. –£–ª—É—á—à–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –≤ CALLER (‚úÖ)

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–µ—Ä–≤—ã—Ö –±–∞–π—Ç:
```typescript
// –ë–´–õ–û: –∂–¥–∞–ª–∏ –∑–∞–∫—Ä—ã—Ç–∏—è writer
async close() {
  await uploadRequestData(requestId, dataBuffer, ...);
}

// –°–¢–ê–õ–û: —Å–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–µ—Ä–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
async write(chunk) {
  dataBuffer.push(chunk);
  if (!dataFileCreated && totalBytes > 0) {
    await uploadRequestData(requestId, dataBuffer, ...);
    dataFileCreated = true;
    onDataUploaded();
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: LISTENER –±—ã—Å—Ç—Ä–µ–µ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É.

### 3. –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (‚úÖ)

–î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–π—Ç –≤ –∫–∞–∂–¥–æ–º —á–∞–Ω–∫–µ
- –°—Ç–∞—Ç—É—Å —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –î–µ—Ç–∞–ª–∏ polling –∏ –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ TCP/TLS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö

## üîß –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è HTTPS

### –ü—Ä–æ–±–ª–µ–º–∞

–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ **"–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å = –æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"** –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:

- **TLS/HTTPS**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞—É–Ω–¥—ã handshake —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º state
- **WebSocket**: –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- **HTTP/2**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ streams –≤ –æ–¥–Ω–æ–º TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏

### –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ: Session Management

#### 1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Å–µ—Å—Å–∏–π

```typescript
interface Session {
  sessionId: string;           // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–µ—Å—Å–∏–∏
  targetAddress: string;       // –ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ (IP –∏–ª–∏ hostname)
  targetPort: number;          // –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞
  tcpConnection: Deno.TcpConn; // –ê–∫—Ç–∏–≤–Ω–æ–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
  createdAt: Date;             // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
  lastActivityAt: Date;        // –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
  requestIds: string[];        // –°–≤—è–∑–∞–Ω–Ω—ã–µ requestId
}
```

#### 2. –ü—Ä–æ—Ç–æ–∫–æ–ª –æ–±–º–µ–Ω–∞ (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞** (`.req` —Ñ–∞–π–ª):
```json
{
  "targetAddress": "77.88.44.242",
  "targetPort": 443,
  "sessionId": "sess-abc123",     // –ù–û–í–û–ï: ID —Å–µ—Å—Å–∏–∏
  "isFirstInSession": true,       // –ù–û–í–û–ï: –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ —Å–µ—Å—Å–∏–∏?
  "keepSessionAlive": true        // –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–µ—Å—Å–∏—é –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞?
}
```

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–µ–π** (`.session` —Ñ–∞–π–ª):
```json
{
  "sessionId": "sess-abc123",
  "command": "close",             // "keep-alive" | "close"
  "timestamp": 1700000000000
}
```

#### 3. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ CALLER

```typescript
class YandexDiskConnectionHandler {
  private activeSessions: Map<string, string> = new Map(); // clientConnId ‚Üí sessionId
  
  async connect(targetAddress: string, targetPort: number): Promise<ConnectedStreams> {
    const clientConnId = generateClientConnId();
    
    // –î–ª—è HTTPS (443) —Å–æ–∑–¥–∞—ë–º/–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Å—Å–∏—é
    let sessionId: string;
    if (targetPort === 443) {
      sessionId = this.getOrCreateSession(targetAddress, targetPort);
      this.activeSessions.set(clientConnId, sessionId);
    } else {
      sessionId = generateRequestId(); // –î–ª—è HTTP - –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è "—Å–µ—Å—Å–∏—è"
    }
    
    const requestId = generateRequestId();
    const isFirstInSession = !this.hasActiveSession(sessionId);
    
    await createRequestMetadata(requestId, {
      targetAddress,
      targetPort,
      sessionId,
      isFirstInSession,
      keepSessionAlive: targetPort === 443
    });
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
  }
}
```

#### 4. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ LISTENER

```typescript
class SessionManager {
  private sessions: Map<string, Session> = new Map();
  
  async handleRequest(request: Request): Promise<void> {
    let session: Session;
    
    if (request.isFirstInSession) {
      // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
      const conn = await Deno.connect({
        hostname: request.targetAddress,
        port: request.targetPort
      });
      
      session = {
        sessionId: request.sessionId,
        tcpConnection: conn,
        targetAddress: request.targetAddress,
        targetPort: request.targetPort,
        createdAt: new Date(),
        lastActivityAt: new Date(),
        requestIds: [request.requestId]
      };
      
      this.sessions.set(request.sessionId, session);
    } else {
      // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
      session = this.sessions.get(request.sessionId);
      if (!session) {
        throw new Error(`Session ${request.sessionId} not found`);
      }
      session.requestIds.push(request.requestId);
      session.lastActivityAt = new Date();
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    await session.tcpConnection.write(request.requestData);
    
    // –ß–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç
    const responseData = await readResponse(session.tcpConnection);
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
    await this.storageProvider.uploadFile(
      this.protocolPaths.response(request.requestId),
      responseData
    );
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å
    if (!request.keepSessionAlive) {
      session.tcpConnection.close();
      this.sessions.delete(request.sessionId);
    }
  }
  
  // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
  async cleanupInactiveSessions(maxIdleTime: number = 60000): Promise<void> {
    const now = Date.now();
    for (const [sessionId, session] of this.sessions) {
      if (now - session.lastActivityAt.getTime() > maxIdleTime) {
        session.tcpConnection.close();
        this.sessions.delete(sessionId);
      }
    }
  }
}
```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

#### –í–∞—Ä–∏–∞–Ω—Ç A: Multiplexing —á–µ—Ä–µ–∑ –æ–¥–∏–Ω requestId

–í–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö requestId –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞—É–Ω–¥–∞ TLS, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–æ–¥–∏–Ω requestId** –¥–ª—è –≤—Å–µ–π —Å–µ—Å—Å–∏–∏:

**–ü—Ä–æ—Ç–æ–∫–æ–ª**:
- `request-id.req` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- `request-id.data` - –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (append mode - –¥–æ–ø–∏—Å—ã–≤–∞—Ç—å, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å)
- `request-id.resp` - –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (append mode)
- `request-id.lock` - —Ñ–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º—ã**:
- –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫ API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç append mode –Ω–∞–ø—Ä—è–º—É—é
- –°–ª–æ–∂–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ü—Ä—è–º–æ–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É CALLER –∏ LISTENER

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è (discovery), –∑–∞—Ç–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä—è–º–æ–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:

**–ü—Ä–æ—Ç–æ–∫–æ–ª**:
1. CALLER –ø–∏—à–µ—Ç –≤ `.mysogatone/discovery/caller-ip.txt` —Å–≤–æ–π –≤–Ω–µ—à–Ω–∏–π IP
2. LISTENER —á–∏—Ç–∞–µ—Ç IP –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∫ CALLER
3. –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ TCP –±–µ–∑ —Ñ–∞–π–ª–æ–≤

**–ü—Ä–æ–±–ª–µ–º—ã**:
- –¢—Ä–µ–±—É–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤ (–ø—Ä–æ–±–ª–µ–º–∞ —Å NAT)
- –ù–∞—Ä—É—à–∞–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏—é "–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ" –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- –¢–µ—Ä—è–µ—Ç—Å—è –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ —Ñ–∞–π–ª—ã

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **Session Management** (–æ—Å–Ω–æ–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ):
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTTPS/TLS
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WebSocket –≤ –±—É–¥—É—â–µ–º
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ —Ñ–∞–π–ª—ã
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (HTTP –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –æ–±–æ–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

## üìù –í—ã–≤–æ–¥—ã

1. **HTTP –ø—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç** - –±–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. **HTTPS —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏** - –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è session management
3. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞** - –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - ~9 —Å–µ–∫—É–Ω–¥ –Ω–∞ HTTP –∑–∞–ø—Ä–æ—Å –ø—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è proof-of-concept

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (MVP –¥–ª—è HTTP):

1. ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è HTTP —Ä–∞–±–æ—Ç–∞—é—Ç
2. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã (E2E)
3. ‚¨ú –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã polling
4. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ HTTPS):

1. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Session Management
2. ‚¨ú –†–∞—Å—à–∏—Ä–∏—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª –æ–±–º–µ–Ω–∞
3. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è HTTPS
4. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å session cleanup

## üìö –°—Å—ã–ª–∫–∏

- [ARCHITECTURE.md](ARCHITECTURE.md) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
- [shared/protocol/PROTOCOL.md](shared/protocol/PROTOCOL.md) - –ü—Ä–æ—Ç–æ–∫–æ–ª –æ–±–º–µ–Ω–∞
- [WINDOWS_TESTING.md](WINDOWS_TESTING.md) - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

