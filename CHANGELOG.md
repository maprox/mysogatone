# Changelog

Все значимые изменения в проекте будут документироваться в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

## [Unreleased]

### Добавлено
- Комплексные тесты для всех компонентов LISTENER (84 теста)
  - Тесты для TCP соединений (tcp-connection.test.ts)
  - Тесты для чтения ответов (response-reader.test.ts)
  - Тесты для обработки ошибок подключения (error-handler.test.ts)
  - Тесты для обработчика подключений (connection-handler.test.ts)
  - Тесты для чтения запросов (request-reader.test.ts)
  - Тесты для очистки запросов (request-cleanup.test.ts)
  - Тесты для утилит listener (utils.test.ts)
  - Тесты для конфигурации (config.test.ts)
  - Тесты для управления папками (folder-manager.test.ts)
  - Тесты для мониторинга (monitor.test.ts)
- Правило в .cursorrules для автоматического запуска тестов после модификации кода
- Git hooks для автоматической проверки кода перед коммитом
  - Pre-commit hook для запуска тестов и линтера
  - Автоматическая проверка Deno проектов (lint, type check, tests)
  - Автоматическая проверка компиляции Kotlin проекта
  - Скрипты установки hooks для разных платформ (sh, bat, js)
  - Автоматическая установка через npm postinstall скрипт
  - Документация по настройке и использованию (GIT_HOOKS.md)
- Полная реализация LISTENER для Яндекс Диск
  - Реализация main.ts с интеграцией всех компонентов
  - Класс Listener для управления жизненным циклом сервера
  - Обработка запросов согласно протоколу (чтение .req и .data файлов)
  - Подключение к целевым серверам (GOAL) и передача данных
  - Запись ответов в .resp файлы
  - Обработка ошибок с созданием .error файлов
  - Graceful shutdown с обработкой сигналов (SIGINT, SIGTERM)
  - Конфигурация через переменные окружения
  - Модульная архитектура с разделением на listener/, request-handler, config, utils
  - Обновлен ConnectionHandler для работы с протоколом (чтение .data, отправка на GOAL, запись .resp)

### Изменено
- Реорганизована структура тестов по папкам компонентов
  - Тесты для connection/ вынесены в tests/connection/
  - Тесты для listener/ вынесены в tests/listener/
  - Тесты для storage-provider/ вынесены в tests/storage-provider/
  - Структура тестов теперь соответствует структуре компонентов
- Переименованы файлы тестов с суффикса _test.ts на расширение .test.ts
  - Все тесты теперь используют единый формат: `component-name.test.ts`
- Рефакторинг LISTENER:
  - Вынесен класс Listener в отдельную папку `listener/`
  - Разбит на модули: config.ts, request-handler.ts, listener.ts, utils.ts
  - Логика обработки запросов вынесена в отдельные функции
  - Упрощен main.ts (только точка входа)
  - Улучшена читаемость и тестируемость кода
- Упрощен скрипт create-test-request.ts:
  - Удалены дублирующие функции создания папок
  - Использование существующих модулей (ensureFoldersExist)
  - Унифицирован дефолтный адрес на ya.ru
  - Упрощен парсинг аргументов

### Исправлено
- Восстановлен retry механизм для HTTP запросов к Яндекс Диск API (maxRetries: 0 → 5)
- Исправлен порядок установки обработчиков сигналов для корректного graceful shutdown
- Исправлена утечка ресурсов TCP соединений в ConnectionHandler (добавлен finally блок для гарантированного закрытия соединения)
- Улучшен pre-commit hook для более надежной работы на Windows
  - Добавлена явная проверка кода выхода тестов
  - Добавлена проверка вывода тестов на наличие ошибок
  - Добавлены понятные сообщения об ошибках при блокировке коммита
  - Обновлена документация (GIT_HOOKS.md) с инструкциями по правильному запуску тестов

### Планируется
- Реализация StorageProvider для CALLER (Deno и Android)
- Интеграция CALLER с облачным хранилищем через StorageProvider
- Тестирование интеграции между LISTENER и CALLER

## [0.1.0] - 2025-11-22

### Добавлено
- Базовая структура монорепозитория
- Архитектурная документация (ARCHITECTURE.md)
- Описание протокола передачи данных через файлы (shared/protocol/PROTOCOL.md)
- TypeScript типы для протокола (shared/protocol/types.ts)
- Базовая структура LISTENER для Яндекс Диск (listeners/yandex-disk/)
- Базовая структура CALLER для Android (callers/android/)
  - SOCKS5 сервер (Socks5Server.kt)
  - SOCKS5 обработчик протокола (Socks5Handler.kt)
  - Абстракция ConnectionHandler (ConnectionHandler.kt)
  - Базовая реализация DefaultConnectionHandler (DefaultConnectionHandler.kt)
- Базовая структура CALLER для Deno (callers/deno/)
- README с описанием проекта и быстрым стартом

#### LISTENER для Яндекс Диск
- Полная реализация StorageProvider для Яндекс Диск API
  - Модульная архитектура (storage-provider/ с разделением на типы, ошибки, утилиты, HTTP клиент, операции с файлами)
  - Методы listFiles, downloadFile, uploadFile, deleteFile
  - Обработка OAuth аутентификации
  - Retry механизм с exponential backoff
  - Обработка rate limits (429) с поддержкой Retry-After заголовка
  - Обработка ошибок API с детальными сообщениями
- Настройка линтера Deno с рекомендуемыми правилами
- Комплексные юнит тесты (47 тестов)
  - Тесты для утилит (11 тестов)
  - Тесты для классов ошибок (3 теста)
  - Тесты для операций с файлами (8 тестов)
  - Тесты для HTTP клиента и retry логики (17 тестов)
  - Тесты для основного провайдера (8 тестов)
- Скрипты для проверки работоспособности
  - `scripts/verify-setup.ts` - проверка настройки без реального API
  - `scripts/check-health.ts` - полная проверка с реальным API
  - `scripts/get-token.ts` - помощь в получении OAuth токена
- Документация
  - `GETTING_TOKEN.md` - подробная инструкция по получению OAuth токена
  - `QUICK_START.md` - быстрый старт для получения токена
  - `CHECKING.md` - руководство по проверке работоспособности
  - Обновлен README с инструкциями по использованию

### Изменено
- Рефакторинг кода StorageProvider:
  - Разбиение большого файла на модульную структуру
  - Использование function declarations вместо const для функций
  - Разделение на мелкие функции для лучшей читаемости
  - Функциональный подход к организации кода

### Исправлено
- Исправлены ошибки типов в тестах
- Исправлена обработка Response body (клонирование для повторного чтения)
- Исправлена проверка URL параметров в тестах

